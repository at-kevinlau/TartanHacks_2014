var initNodes = [{"courseId":"18051","treeType":"OR","isStarter":true},{"courseId":"18100","treeType":"OR","isStarter":true},{"courseId":"21120","treeType":"OR","isStarter":true},{"courseId":"18202","treeType":"OR","isStarter":true},{"courseId":"21122","treeType":"OR","isStarter":true},{"courseId":"21118","treeType":"OR","isStarter":true},{"courseId":"21123","treeType":"OR","isStarter":true},{"courseId":"18213","treeType":"OR","isStarter":true},{"courseId":"15122","treeType":"OR","isStarter":true},{"courseId":"18220","treeType":"OR","isStarter":true},{"courseId":"33107","treeType":"OR","isStarter":true},{"courseId":"18232","treeType":"OR","isStarter":true},{"courseId":"18240","treeType":"OR","isStarter":true},{"courseId":"21127","treeType":"OR","isStarter":true},{"courseId":"18290","treeType":"OR","isStarter":true},{"courseId":"18310","treeType":"OR","isStarter":true},{"courseId":"18332","treeType":"OR","isStarter":true},{"courseId":"18340","treeType":"OR","isStarter":true},{"courseId":"18345","treeType":"AND","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"36217","treeType":"OR","isStarter":true},{"courseId":"36212","treeType":"OR","isStarter":true},{"courseId":"36226","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"18348","treeType":"AND","isStarter":true},{"courseId":"18390","treeType":"OR","isStarter":true},{"courseId":"18402","treeType":"OR","isStarter":true},{"courseId":"18300","treeType":"OR","isStarter":true},{"courseId":"18411","treeType":"AND","isStarter":true},{"courseId":"15100","treeType":"OR","isStarter":true},{"courseId":"21259","treeType":"OR","isStarter":true},{"courseId":"21260","treeType":"OR","isStarter":true},{"courseId":"18418","treeType":"OR","isStarter":true},{"courseId":"18421","treeType":"AND","isStarter":true},{"courseId":"18320","treeType":"OR","isStarter":true},{"courseId":"18422","treeType":"AND","isStarter":true},{"courseId":"18432","treeType":"OR","isStarter":true},{"courseId":"18447","treeType":"AND","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"15213","treeType":"OR","isStarter":true},{"courseId":"18243","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"18341","treeType":"OR","isStarter":true},{"courseId":"18349","treeType":"OR","isStarter":true},{"courseId":"18474","treeType":"AND","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"18396","treeType":"OR","isStarter":true},{"courseId":"18370","treeType":"OR","isStarter":true},{"courseId":"18482","treeType":"OR","isStarter":true},{"courseId":"73100","treeType":"OR","isStarter":true},{"courseId":"18491","treeType":"OR","isStarter":true},{"courseId":"18510","treeType":"OR","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"18540","treeType":"AND","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"18549","treeType":"AND","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"15410","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"18551","treeType":"AND","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"18496","treeType":"OR","isStarter":true},{"courseId":"18578","treeType":"OR","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"15313","treeType":"OR","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"18601","treeType":"OR","isStarter":true},{"courseId":"18603","treeType":"OR","isStarter":true},{"courseId":"18610","treeType":"OR","isStarter":true},{"courseId":"18615","treeType":"OR","isStarter":true},{"courseId":"18625","treeType":"OR","isStarter":true},{"courseId":"18637","treeType":"OR","isStarter":true},{"courseId":"18640","treeType":"OR","isStarter":true},{"courseId":"18641","treeType":"OR","isStarter":true},{"courseId":"18645","treeType":"OR","isStarter":true},{"courseId":"18698","treeType":"OR","isStarter":true},{"courseId":"18721","treeType":"OR","isStarter":true},{"courseId":"18623","treeType":"OR","isStarter":true},{"courseId":"18731","treeType":"OR","isStarter":true},{"courseId":"18630","treeType":"OR","isStarter":true},{"courseId":"18730","treeType":"OR","isStarter":true},{"courseId":"18732","treeType":"OR","isStarter":true},{"courseId":"18733","treeType":"OR","isStarter":true},{"courseId":"18739","treeType":"OR","isStarter":true},{"courseId":"18745","treeType":"OR","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"18391","treeType":"OR","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"","treeType":"AND","isStarter":true},{"courseId":"18746","treeType":"OR","isStarter":true},{"courseId":"18748","treeType":"OR","isStarter":true},{"courseId":"18752","treeType":"OR","isStarter":true},{"courseId":"18751","treeType":"OR","isStarter":true},{"courseId":"18753","treeType":"OR","isStarter":true},{"courseId":"18759","treeType":"AND","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"15441","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"18760","treeType":"AND","isStarter":true},{"courseId":"15214","treeType":"OR","isStarter":true},{"courseId":"18764","treeType":"OR","isStarter":true},{"courseId":"18765","treeType":"AND","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"18791","treeType":"OR","isStarter":true},{"courseId":"18795","treeType":"OR","isStarter":true},{"courseId":"18799","treeType":"OR","isStarter":true},{"courseId":"18819","treeType":"OR","isStarter":true},{"courseId":"18842","treeType":"AND","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"15412","treeType":"OR","isStarter":true},{"courseId":"14342","treeType":"OR","isStarter":true},{"courseId":"18342","treeType":"OR","isStarter":true},{"courseId":"","treeType":"OR","isStarter":true},{"courseId":"18756","treeType":"OR","isStarter":true},{"courseId":"14740","treeType":"OR","isStarter":true},{"courseId":"18843","treeType":"OR","isStarter":true},{"courseId":"18845","treeType":"OR","isStarter":true},{"courseId":"18869","treeType":"OR","isStarter":true},{"courseId":"18875","treeType":"OR","isStarter":true},{"courseId":"18879","treeType":"OR","isStarter":true},{"courseId":"18470","treeType":"OR","isStarter":true},{"courseId":"18372","treeType":"OR","isStarter":true},{"courseId":"18902","treeType":"OR","isStarter":true},{"courseId":"18980","treeType":"OR","isStarter":true},{"courseId":"18984","treeType":"OR","isStarter":true},{"courseId":"18990","treeType":"OR","isStarter":true},{"courseId":"18992","treeType":"OR","isStarter":true},{"courseId":"18994","treeType":"OR","isStarter":true},{"courseId":"18995","treeType":"OR","isStarter":true}]

var initLinks = [{"source":1,"target":2},{"source":3,"target":4},{"source":3,"target":5},{"source":3,"target":6},{"source":7,"target":8},{"source":9,"target":1},{"source":9,"target":3},{"source":9,"target":10},{"source":12,"target":1},{"source":12,"target":13},{"source":14,"target":1},{"source":14,"target":3},{"source":15,"target":9},{"source":17,"target":12},{"source":19,"target":20},{"source":19,"target":21},{"source":19,"target":22},{"source":18,"target":19},{"source":23,"target":7},{"source":18,"target":23},{"source":24,"target":12},{"source":24,"target":7},{"source":26,"target":27},{"source":28,"target":29},{"source":28,"target":2},{"source":28,"target":4},{"source":28,"target":30},{"source":28,"target":31},{"source":32,"target":9},{"source":33,"target":14},{"source":33,"target":34},{"source":35,"target":12},{"source":35,"target":34},{"source":38,"target":12},{"source":37,"target":38},{"source":39,"target":40},{"source":39,"target":7},{"source":39,"target":41},{"source":37,"target":39},{"source":42,"target":17},{"source":42,"target":43},{"source":42,"target":24},{"source":42,"target":44},{"source":42,"target":34},{"source":37,"target":42},{"source":46,"target":40},{"source":46,"target":41},{"source":45,"target":46},{"source":47,"target":48},{"source":47,"target":49},{"source":45,"target":47},{"source":50,"target":51},{"source":52,"target":14},{"source":54,"target":27},{"source":54,"target":34},{"source":53,"target":54},{"source":55,"target":27},{"source":55,"target":52},{"source":53,"target":55},{"source":56,"target":15},{"source":56,"target":34},{"source":53,"target":56},{"source":57,"target":15},{"source":57,"target":52},{"source":53,"target":57},{"source":58,"target":52},{"source":58,"target":34},{"source":53,"target":58},{"source":59,"target":27},{"source":59,"target":33},{"source":53,"target":59},{"source":60,"target":15},{"source":60,"target":33},{"source":53,"target":60},{"source":62,"target":34},{"source":62,"target":49},{"source":62,"target":52},{"source":61,"target":62},{"source":63,"target":17},{"source":63,"target":43},{"source":63,"target":24},{"source":63,"target":44},{"source":61,"target":63},{"source":65,"target":34},{"source":65,"target":49},{"source":65,"target":52},{"source":65,"target":37},{"source":65,"target":66},{"source":64,"target":65},{"source":67,"target":24},{"source":67,"target":44},{"source":64,"target":67},{"source":69,"target":52},{"source":68,"target":69},{"source":70,"target":49},{"source":70,"target":71},{"source":70,"target":24},{"source":70,"target":44},{"source":68,"target":70},{"source":73,"target":24},{"source":73,"target":34},{"source":72,"target":73},{"source":74,"target":24},{"source":74,"target":75},{"source":72,"target":74},{"source":76,"target":49},{"source":76,"target":24},{"source":72,"target":76},{"source":77,"target":44},{"source":77,"target":49},{"source":72,"target":77},{"source":78,"target":44},{"source":78,"target":75},{"source":72,"target":78},{"source":79,"target":44},{"source":79,"target":34},{"source":72,"target":79},{"source":80,"target":49},{"source":80,"target":34},{"source":72,"target":80},{"source":83,"target":15},{"source":84,"target":15},{"source":87,"target":37},{"source":91,"target":92},{"source":93,"target":94},{"source":93,"target":95},{"source":96,"target":95},{"source":97,"target":95},{"source":98,"target":95},{"source":100,"target":24},{"source":100,"target":34},{"source":99,"target":100},{"source":101,"target":24},{"source":101,"target":102},{"source":99,"target":101},{"source":103,"target":44},{"source":103,"target":34},{"source":99,"target":103},{"source":104,"target":44},{"source":104,"target":102},{"source":99,"target":104},{"source":105,"target":34},{"source":105,"target":102},{"source":99,"target":105},{"source":106,"target":34},{"source":106,"target":17},{"source":99,"target":106},{"source":107,"target":34},{"source":107,"target":43},{"source":99,"target":107},{"source":108,"target":7},{"source":109,"target":24},{"source":109,"target":44},{"source":109,"target":66},{"source":110,"target":111},{"source":112,"target":20},{"source":114,"target":115},{"source":114,"target":18},{"source":113,"target":114},{"source":116,"target":102},{"source":113,"target":116},{"source":117,"target":118},{"source":117,"target":12},{"source":117,"target":34},{"source":119,"target":34},{"source":121,"target":118},{"source":120,"target":121},{"source":122,"target":12},{"source":120,"target":122},{"source":123,"target":43},{"source":123,"target":17},{"source":120,"target":123},{"source":125,"target":14},{"source":126,"target":14},{"source":127,"target":9},{"source":129,"target":66},{"source":129,"target":130},{"source":129,"target":131},{"source":129,"target":132},{"source":129,"target":24},{"source":129,"target":44},{"source":128,"target":129},{"source":133,"target":18},{"source":133,"target":134},{"source":133,"target":135},{"source":128,"target":133},{"source":136,"target":66},{"source":137,"target":7},{"source":140,"target":141},{"source":140,"target":49},{"source":140,"target":142}]

var width = window.innerWidth,
    height = window.innerHeight,
    fill = d3.scale.category20();
/*var width = 960,
	height = 500;*/

// mouse event vars
var selected_node = null;

// init svg
var outer = d3.select("#chart")
  .append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("pointer-events", "all");

//defines what arrowhead looks like
outer.append('svg:defs').append('svg:marker')
    .attr('id', 'start-arrow')
    .attr('viewBox', '0 -5 10 10')
    .attr('refX', 4)
    .attr('markerWidth', 3)
    .attr('markerHeight', 3)
    .attr('orient', 'auto')
  .append('svg:path')
    .attr('d', 'M10,-5L0,0L10,5')
    .attr('fill', '#000');

//
var vis = outer
 	.append('g')
 	//special transform...
 	.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
    .call(d3.behavior.zoom()
    .scaleExtent([0,10])	//limits zooming
    .on("zoom", rescale))
    .on("dblclick.zoom", null)
  	.append('svg:g');

  	
//creates the background
vis.append('svg:rect')
	.attr("class","overlay")
	.attr("x",-width/2)
	.attr("y", -height/2)
    .attr('width', width)
    .attr('height', height)
    .attr('fill','white');

// init force layout
var force = d3.layout.force()
    .size([.75,.75])
    .nodes(initNodes)
    .links(initLinks)
    .linkDistance(3)
    .linkStrength(1)
    .charge(-1000)
    .gravity(1)
//    .size([width*=.5, height *= .5])
    .on("tick", tick);

// get layout properties
var nodes = force.nodes(),
    links = force.links();

//makes arrow heads
var link = vis.selectAll(".link").data(links)
    .enter().insert("svg:path")
    .attr("class", "link")
    .style('marker-start', 'url(#start-arrow)')

var node = vis.selectAll(".node").data(nodes)
    .enter().append("g")
    .attr("class", "node")
    .on("click", 
      function(d) {
        mousedown_node = d;
        if (mousedown_node == selected_node) selected_node = null;
        else {
          selected_node = mousedown_node;
          d3.select(this).select("circle").transition()
            .duration(750)
            .attr("r", 20);
        }
          node.classed("node_selected", function(d) {
            return d === selected_node; });
      })
node.append("circle")
    .attr("r", 10)
node.append("text")
    .attr("dx", 12)
    .attr("dy", ".35em")
    .text(function(d) { return d.courseId; })

force.start();

function tick() {
  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; })
      .attr('d', function(d) {
        var deltaX = d.target.x - d.source.x,
        deltaY = d.target.y - d.source.y,
        dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY),
        normX = deltaX / dist,
        normY = deltaY / dist,
        sourcePadding = 10,
        targetPadding = 0,
        sourceX = d.source.x + (sourcePadding * normX),
        sourceY = d.source.y + (sourcePadding * normY),
        targetX = d.target.x - (targetPadding * normX),
        targetY = d.target.y - (targetPadding * normY);
        return 'M' + sourceX + ',' + sourceY + 'L' + targetX + ',' + targetY;
      });
      
  node.attr("transform",
      function(d,i) {return "translate(" + d.x + ", " + d.y + ")"});
}

// pan and scale
function rescale() {
  trans=d3.event.translate;
  scale=d3.event.scale;

  // keep in screen
  trans[0] = Math.min(width / 2 * (scale - 1), Math.max(width / 2 * (1 - scale), trans[0]));
  trans[1] = Math.min(height / 2 * (scale - 1) + 230 * scale, Math.max(height / 2 * (1 - scale) - 230 * scale, trans[1]));

  vis.attr("transform",
      "translate(" + trans + ")"
      + " scale(" + scale + ")");
 // d3.layout.force().charge().translate(trans).scale(scale);
  d3.behavior.zoom().translate(trans);
}

